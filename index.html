<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>経堂シフト閲覧ポータル | Kyodo Shift Dashboard</title>
  <!-- React & Tailwind CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Roboto:wght@700&display=swap');
    
    body { font-family: 'Noto Sans JP', sans-serif; background-color: #ffffff; color: #1e293b; margin: 0; padding: 0; }

    /* 印刷設定: A4横・2段組 */
    @media print {
      @page { size: A4 landscape; margin: 5mm; }
      body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .no-print { display: none !important; }
      .print-container { padding: 0 !important; width: 100% !important; max-width: none !important; }
      .page-break { break-after: page; page-break-after: always; height: 0; display: block; }
      .table-wrapper { border: 2px solid #94a3b8 !important; border-radius: 0 !important; overflow: visible !important; }
      th, td { border: 1px solid #94a3b8 !important; }
      .bg-red-50 { background-color: #fef2f2 !important; }
      .bg-blue-50 { background-color: #eff6ff !important; }
    }

    /* 名前セル: 幅固定・中央揃え */
    .name-cell { 
      background-color: #ffffff !important; 
      width: 140px !important; min-width: 140px !important;
      font-size: 1.2rem; font-weight: 900;
      text-align: center !important; vertical-align: middle !important;
      color: #1e293b; border-right: 3px solid #C21642 !important;
      white-space: nowrap; overflow: hidden;
    }
    
    /* 勤務時間バッジ */
    .time-badge { 
      display: inline-flex; align-items: center; justify-content: center;
      color: #1f2937; font-family: 'Roboto', sans-serif; font-size: 0.75rem; letter-spacing: -0.05em;
      font-weight: 900; line-height: 1; white-space: nowrap; padding: 2px 4px; width: 100%;
    }

    /* メモテキスト */
    .memo-text {
      font-size: 0.7rem; color: #334155; font-weight: 700; line-height: 1.2;
      display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; text-align: center;
    }

    .holiday-x { color: #dc2626; font-size: 1.1rem; font-weight: 700; opacity: 0.7; }
    .paid-leave { color: #059669; font-weight: 900; font-size: 0.85rem; background: #d1fae5; padding: 2px 6px; border-radius: 4px; }
    
    /* 行・セル設定 */
    .row-shift { height: 40px; }
    .row-memo { height: 60px; } /* メモ欄を広く */
    .day-cell {
      width: 90px !important; min-width: 90px !important; max-width: 90px !important;
      padding: 2px 4px !important; vertical-align: middle; text-align: center;
    }
    
    .text-sun { color: #dc2626 !important; }
    .text-sat { color: #2563eb !important; }
    .bg-sun { background-color: #fef2f2 !important; }
    .bg-sat { background-color: #eff6ff !important; }

    .table-title {
      font-size: 1.4rem; font-weight: 900; color: #C21642;
      padding: 8px 20px; background-color: #fff1f2; border-left: 8px solid #C21642;
      margin-bottom: 15px; display: inline-block;
    }

    .tier-container { margin-bottom: 0; page-break-inside: avoid; }
    .stats-cell { background-color: #f8fafc !important; font-weight: 900; font-size: 0.8rem !important; }
    
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid #C21642; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite; display: inline-block;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, Fragment } = React;

    const CONFIG = {
      // ★提供されたGASのデプロイURLを設定済み
      GAS_API_URL: "https://script.google.com/macros/s/AKfycbyLLX4EzfuvswXUgFwL19U8ZeZcuQ4pr287p-etGdEwG3Ej6kFMCAqkqR2hlr1FvaEo/exec" 
    };

    /**
     * データ整形関数
     */
    function formatCellContent(value) {
      if (!value) return "";
      const str = String(value);
      if (str === '×' || str === '公休' || str === '休') return <span className="holiday-x">×</span>;
      if (str.includes('有給') || str.includes('有休')) return <span className="paid-leave">有給</span>;
      
      // 変な英語の日付対策
      if (str.includes("GMT") || (str.match(/[A-Za-z]{3}\s[A-Za-z]{3}/) && str.length > 10)) {
        try {
          const d = new Date(str);
          if (!isNaN(d.getTime())) {
            const h = d.getHours();
            const m = d.getMinutes();
            if (h === 0 && m === 0) return <span className="text-xs text-gray-400 font-bold">{d.getDate()}日</span>;
            const timeStr = `${h}:${m.toString().padStart(2, '0')}`;
            return <div className="time-badge">{timeStr}</div>;
          }
        } catch (e) { return <span className="text-[8px] text-red-300">Err</span>; }
      }

      // 数字を含む場合（時間）
      if (/\d/.test(str)) return <div className="time-badge">{str}</div>;
      return <span className="text-xs font-bold text-gray-500">{str}</span>;
    }

    function App() {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        const fetchData = async () => {
          try {
            if (CONFIG.GAS_API_URL.includes("YOUR_GAS")) throw new Error("GASのURLが設定されていません。index.htmlを編集してください。");
            
            const res = await fetch(CONFIG.GAS_API_URL);
            const json = await res.json();
            if (json.error) throw new Error(json.error);
            setData(json);
          } catch (err) {
            setError(err.message || "データ取得エラー");
          } finally {
            setLoading(false);
          }
        };
        fetchData();
      }, []);

      if (loading) return (
        <div className="min-h-screen flex flex-col items-center justify-center space-y-4">
          <div className="loader"></div>
          <p className="font-bold text-gray-400 tracking-widest text-xs">LOADING...</p>
        </div>
      );

      if (error) return (
        <div className="p-10 text-center">
          <p className="text-red-500 font-bold mb-4">{error}</p>
          <button onClick={() => window.location.reload()} className="bg-gray-200 px-4 py-2 rounded">Retry</button>
        </div>
      );

      return (
        <div className="p-2 md:p-6 print:p-0">
          <div className="max-w-full mx-auto">
            {/* ヘッダー */}
            <header className="flex justify-between items-end mb-6 no-print border-b pb-4">
              <h1 className="text-3xl font-black text-gray-800">{data.month}</h1>
              <div className="text-sm text-gray-500 font-bold">
                ※印刷時は「横向き」「倍率: 用紙に合わせる」に設定してください
              </div>
              <button onClick={() => window.print()} className="bg-gray-900 text-white px-6 py-3 rounded-lg font-bold hover:bg-black transition shadow-lg">
                印刷する (A4横)
              </button>
            </header>

            <main>
              {/* 1ページ目: 上旬 (1日〜15日) */}
              <ShiftTierTable data={data} start={0} end={15} label="上旬 (1日〜15日)" />
              
              {/* 強制改ページ */}
              <div className="page-break"></div>
              
              {/* 2ページ目: 下旬 (16日〜末日) + 集計 */}
              <ShiftTierTable data={data} start={15} end={data.dates.length} label="下旬 (16日〜末日)" showStats={true} />
            </main>
          </div>
        </div>
      );
    }

    function ShiftTierTable({ data, start, end, label, showStats = false }) {
      const datesInRange = data.dates.slice(start, end);
      const dowsInRange = data.dows.slice(start, end);

      return (
        <div className="tier-container">
          <div className="table-title">{label}</div>
          <div className="table-wrapper border border-gray-400 overflow-hidden">
            <table className="w-full border-collapse bg-white table-fixed">
              <colgroup>
                <col style={{width: '140px'}} /> {/* 名前列 */}
                {datesInRange.map((_, i) => <col key={i} style={{width: '90px'}} />)} {/* 日付列: 90pxに拡大 */}
                {showStats && (
                  <>
                    <col style={{width: '60px'}} />
                    <col style={{width: '40px'}} />
                    <col style={{width: '40px'}} />
                  </>
                )}
              </colgroup>
              <thead>
                {/* 日付行 */}
                <tr className="bg-white border-b border-gray-300 h-10">
                  <th className="empty-corner border-r-[3px] border-[#C21642]"></th>
                  {datesInRange.map((d, i) => (
                    <th key={i} className="text-[0.85rem] font-bold text-gray-700 border-l border-gray-300">{d}</th>
                  ))}
                  {showStats && <th colSpan={3} className="bg-gray-800 text-white text-[10px] font-bold">集計</th>}
                </tr>
                {/* 曜日行 */}
                <tr className="bg-slate-50 border-b border-gray-300 h-8">
                  <td className="empty-corner border-r-[3px] border-[#C21642]"></td>
                  {dowsInRange.map((dw, i) => {
                    const cls = dw === '日' ? 'text-sun bg-red-50' : dw === '土' ? 'text-sat bg-blue-50' : 'text-gray-500';
                    return <td key={i} className={`text-[0.8rem] font-bold border-l border-gray-300 text-center ${cls}`}>{dw}</td>;
                  })}
                  {showStats && (
                    <>
                      <td className="bg-gray-100 text-[9px] font-bold text-center border-l border-gray-300">時間</td>
                      <td className="bg-gray-100 text-[9px] font-bold text-center border-l border-gray-100">休</td>
                      <td className="bg-gray-100 text-[9px] font-bold text-center border-l border-gray-100">有</td>
                    </>
                  )}
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-300">
                {data.staffs.map((staff, sIdx) => {
                  const isMito = staff.name.includes("みと");
                  return (
                    <Fragment key={sIdx}>
                      {/* 上段：シフト時間 */}
                      <tr className="row-shift">
                        <td rowSpan={2} className="name-cell border-b border-gray-400">
                          {staff.name}
                        </td>
                        {datesInRange.map((_, i) => {
                          const s = staff.shifts[start + i];
                          const dw = dowsInRange[i];
                          const bgCls = dw === '日' ? 'bg-red-50' : dw === '土' ? 'bg-blue-50' : '';
                          
                          return (
                            <td key={i} className={`day-cell border-l border-gray-300 text-center ${bgCls}`}>
                              {formatCellContent(s)}
                            </td>
                          );
                        })}
                        {showStats && (
                          <>
                            <td rowSpan={2} className="bg-slate-50 border-l border-b border-gray-400 text-center align-middle p-1 stats-cell">
                              {(isMito && parseFloat(staff.total)===0) ? "" : `${staff.total}h`}
                            </td>
                            <td rowSpan={2} className="bg-slate-50 border-l border-b border-gray-400 text-center align-middle p-1 stats-cell text-red-600">
                              {(isMito && staff.holidays===0) ? "" : staff.holidays}
                            </td>
                            <td rowSpan={2} className="bg-slate-50 border-l border-b border-gray-400 text-center align-middle p-1 stats-cell text-emerald-600">
                              {(isMito && staff.paidLeave===0) ? "" : staff.paidLeave}
                            </td>
                          </>
                        )}
                      </tr>
                      {/* 下段：メモ */}
                      <tr className="row-memo border-b border-gray-400">
                        {datesInRange.map((_, i) => {
                          const m = staff.memos[start + i];
                          const dw = dowsInRange[i];
                          const bgCls = dw === '日' ? 'bg-red-50' : dw === '土' ? 'bg-blue-50' : '';
                          return (
                            <td key={i} className={`day-cell border-l border-gray-300 align-top pt-1 ${bgCls}`}>
                              <span className="memo-text">{m}</span>
                            </td>
                          );
                        })}
                      </tr>
                    </Fragment>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>